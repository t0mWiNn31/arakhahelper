<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arakha DM - Secure Terminal</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #050505; color: #00ff41; font-family: 'Courier New', Courier, monospace; height: 100dvh; display: flex; justify-content: center; overflow: hidden; }
        .terminal-container { width: 100%; max-width: 600px; height: 100dvh; background: #0a0a0a; display: flex; flex-direction: column; border-left: 1px solid #1a1a1a; border-right: 1px solid #1a1a1a; }
        
        .terminal-header { background: #111; padding: 12px 15px; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #00ff41; }
        .back-btn { background: none; border: 1px solid #444; color: #ccc; padding: 4px 8px; cursor: pointer; font-size: 12px; border-radius: 4px; }
        #chat-with-avatar { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #00ff41; object-fit: cover; }
        #title { font-size: 11px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .status-dot { width: 8px; height: 8px; background: #555; border-radius: 50%; }
        .status-online { background: #00ff41; box-shadow: 0 0 5px #00ff41; }

        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }

        /* DM Bubble Style */
        .msg-row { display: flex; gap: 8px; max-width: 85%; }
        .msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.others { align-self: flex-start; }
        
        .bubble { padding: 10px 14px; border-radius: 12px; font-size: 14px; word-break: break-word; line-height: 1.4; position: relative; }
        .mine .bubble { color: #fff; background: #004d1a; border: 1px solid #00ff41; border-bottom-right-radius: 2px; }
        .others .bubble { color: #00ff41; background: #1a1a1a; border: 1px solid #333; border-bottom-left-radius: 2px; }
        
        .time-tag { font-size: 8px; opacity: 0.4; margin-top: 4px; display: block; }

        .input-area { padding: 15px; background: #111; border-top: 1px solid #333; display: flex; gap: 10px; }
        input { flex: 1; background: #000; border: 1px solid #333; color: #00ff41; padding: 12px; outline: none; border-radius: 20px; font-size: 14px; }
        input:focus { border-color: #00ff41; }
        button#sendBtn { background: #00ff41; color: #000; border: none; width: 40px; height: 40px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="terminal-container">
    <div class="terminal-header">
        <button class="back-btn" onclick="window.location.href='forum.html'">‚Üê</button>
        <div id="header-avatar-container"></div>
        <div id="title">LOADING_SECURE_CHANNEL...</div>
        <div id="status-dot" class="status-dot"></div>
    </div>

    <div id="messages"></div>

    <div class="input-area">
        <input type="text" id="msg" placeholder="Type a message..." autocomplete="off" onkeypress="if(event.key==='Enter')send()">
        <button id="sendBtn" onclick="send()">‚û§</button>
    </div>
</div>

<script>
    const config = {
        apiKey: "AIzaSyCpIv3avDNRYNrmrzKdMqfnMdNzBGZAPow",
        authDomain: "firstarakha.firebaseapp.com",
        projectId: "firstarakha",
        databaseURL: "https://firstarakha-default-rtdb.asia-southeast1.firebasedatabase.app", 
        appId: "1:4263070909:web:ef4e4a2c0891be1f49bbd4"
    };
    firebase.initializeApp(config);
    const db = firebase.database();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const targetUid = urlParams.get('id'); // ·ÄÖ·ÄÄ·Ä¨·Ä∏·Äï·Äº·Ä±·Ä¨·Äô·Äö·Ä∑·Ä∫·Äû·Ä∞·Ä∑ ID

    auth.onAuthStateChanged(user => {
        if (!user) window.location.replace("index.html");
        else if (!targetUid) window.location.replace("forum.html"); // ID ·Äô·Äï·Ä´·Äõ·ÄÑ·Ä∫ ·Äï·Äº·Äî·Ä∫·Äú·ÄΩ·Äæ·Äê·Ä∫·Äô·Äö·Ä∫
        else {
            setupChat(user.uid, targetUid);
        }
    });

    function setupChat(myUid, toUid) {
        // DM Room ID ·Äñ·Äî·Ä∫·Äê·ÄÆ·Ä∏·Äî·Ää·Ä∫·Ä∏ (UID ·Äî·Äæ·ÄÖ·Ä∫·ÄÅ·ÄØ·ÄÄ·Ä≠·ÄØ ·Ä°·ÄÖ·Äâ·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·ÄÖ·ÄÆ·Äï·Äº·ÄÆ·Ä∏ ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äê·Ä¨·Äï·Ä´ - ·Ä°·Äô·Äº·Ä≤·Äê·Äô·Ä∫·Ä∏ Unique ·Äñ·Äº·ÄÖ·Ä∫·Äî·Ä±·Ä°·Ä±·Ä¨·ÄÑ·Ä∫)
        const roomId = myUid < toUid ? myUid + "_" + toUid : toUid + "_" + myUid;

        // ·ÅÅ·Åã ·Äê·ÄÖ·Ä∫·Äñ·ÄÄ·Ä∫·Äú·Ä∞·Äõ·Ä≤·Ä∑ Profile ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äö·Ä∞·Äô·Äö·Ä∫
        db.ref('users/' + toUid).on('value', snap => {
            const data = snap.val() || {};
            const name = data.username || "Unknown User";
            document.getElementById('title').innerText = "DM::" + name.toUpperCase();
            
            // Avatar ·Äï·Äº·Äô·Äö·Ä∫
            const avatarContainer = document.getElementById('header-avatar-container');
            if(data.profilePic && data.profilePic.startsWith('http')) {
                avatarContainer.innerHTML = `<img src="${data.profilePic}" id="chat-with-avatar">`;
            } else {
                avatarContainer.innerHTML = `<div style="font-size:20px;">${data.profilePic || 'üë§'}</div>`;
            }

            // Online Status ·Äï·Äº·Äô·Äö·Ä∫
            const dot = document.getElementById('status-dot');
            if(data.isOnline) dot.classList.add('status-online');
            else dot.classList.remove('status-online');
        });

        // ·ÅÇ·Åã ·Äô·ÄÄ·Ä∫·ÄÜ·Ä±·Ä∑·Äê·ÄΩ·Ä± ·ÄÜ·ÄΩ·Ä≤·Äë·ÄØ·Äê·Ä∫·Äô·Äö·Ä∫
        db.ref("dms/" + roomId).limitToLast(50).on("child_added", snap => {
            const data = snap.val();
            displayMessage(data, myUid);
        });

        // ·ÅÉ·Åã ·Äï·Ä≠·ÄØ·Ä∑·Äê·Ä≤·Ä∑ Function ·ÄÄ·Ä≠·ÄØ window ·Äë·Ä≤ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä±·Ä∏·Äô·Äö·Ä∫
        window.send = function() {
            const txt = document.getElementById('msg').value.trim();
            if(txt) {
                db.ref("dms/" + roomId).push({
                    sender: myUid,
                    text: txt,
                    time: firebase.database.ServerValue.TIMESTAMP
                });
                document.getElementById('msg').value = "";
            }
        };
    }

    function displayMessage(data, myUid) {
        const msgDiv = document.getElementById('messages');
        const isMine = data.sender === myUid;
        const timeStr = new Date(data.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const div = document.createElement('div');
        div.className = 'msg-row ' + (isMine ? 'mine' : 'others');
        div.innerHTML = `
            <div class="msg-content">
                <div class="bubble">
                    ${data.text}
                    <span class="time-tag">${timeStr}</span>
                </div>
            </div>
        `;
        msgDiv.appendChild(div);
        msgDiv.scrollTop = msgDiv.scrollHeight;
    }
</script>
</body>
</html>
